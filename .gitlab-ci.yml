# using docker in docker. It's wase to use the overlayfs driver for
# improved performance and reduce disk usage.
variables:
    DOCKER_DRIVER: overlay

before_script:
    - docker info
    - git submodule sync --recursive
    - git submodule update --init --recursive

stages:
    - build_image
    - build
    - cleanup

image_build:
    stage: build_image
    script:
      - docker build --tag haskell-aes:latest docker

scarlet_build:
    stage: build
    script:
    # avec docker + gitlab c'est compliqué de maintenir les 'build artifacts'
    # entre les passes gitlab, et entre plusieurs exécutions d'un même conteneur
    # docker.  Donc acte, on fait tout dans un seul makefile.
      - docker run --volume $(pwd):/haskell-aes --env LOCAL_USER_ID=$(id -u) --interactive haskell-aes:latest make test

scarlet_cleanup:
    stage: cleanup
    script:
      - docker run --rm --volume $(pwd):/haskell-aes --env LOCAL_USER_ID=$(id -u) --interactive haskell-aes:latest ls
